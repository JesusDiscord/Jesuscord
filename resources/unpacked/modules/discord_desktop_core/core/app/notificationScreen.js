"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.init=init,exports.close=close,exports.setMainWindow=setMainWindow,exports.hasInit=exports.NOTIFICATION_CLICK=exports.events=void 0;var _electron=require("electron"),_fs=_interopRequireDefault(require("fs")),_path=_interopRequireDefault(require("path")),_events=require("events"),_url=_interopRequireDefault(require("url")),_ipcMain=_interopRequireDefault(require("./ipcMain"));function _interopRequireDefault(i){return i&&i.__esModule?i:{default:i}}const IPC_NOTIFICATIONS_CLEAR="NOTIFICATIONS_CLEAR",IPC_NOTIFICATION_SHOW="NOTIFICATION_SHOW",IPC_NOTIFICATION_CLICK="NOTIFICATION_CLICK",IPC_NOTIFICATION_CLOSE="NOTIFICATION_CLOSE",IPC_THEME_UPDATE="UPDATE_THEME",events=new _events.EventEmitter;exports.events=events;const NOTIFICATION_CLICK="notification-click";exports.NOTIFICATION_CLICK=NOTIFICATION_CLICK;let hasInit=!1;exports.hasInit=hasInit;const variablesFilePath=_path.default.join(__dirname,"notifications","variables.json");let mainWindow,title,maxVisible,screenPosition,notifications,hideTimeout,notificationWindow,VARIABLES;function webContentsSend(i,e,...n){null!=i&&null!=i.webContents&&i.webContents.send("DISCORD_"+e,...n)}function init({mainWindow:i,title:e,maxVisible:n,screenPosition:t}){hasInit?console.warn("notificationScreen: Has already init! Cancelling init."):(exports.hasInit=hasInit=!0,VARIABLES=JSON.parse(_fs.default.readFileSync(variablesFilePath)),mainWindow=i,title=e,maxVisible=n,screenPosition=t,notifications=[],hideTimeout=null,_ipcMain.default.on("NOTIFICATIONS_CLEAR",handleNotificationsClear),_ipcMain.default.on("NOTIFICATION_SHOW",handleNotificationShow),_ipcMain.default.on("NOTIFICATION_CLICK",handleNotificationClick),_ipcMain.default.on("NOTIFICATION_CLOSE",handleNotificationClose),_ipcMain.default.on("UPDATE_THEME",handleThemeUpdate))}function destroyWindow(){null!=notificationWindow&&(notificationWindow.hide(),notificationWindow.close(),notificationWindow=null)}function close(){mainWindow=null,destroyWindow(),_ipcMain.default.removeListener("NOTIFICATIONS_CLEAR",handleNotificationsClear),_ipcMain.default.removeListener("NOTIFICATION_SHOW",handleNotificationShow),_ipcMain.default.removeListener("NOTIFICATION_CLICK",handleNotificationClick),_ipcMain.default.removeListener("NOTIFICATION_CLOSE",handleNotificationClose),_ipcMain.default.removeListener("UPDATE_THEME",handleThemeUpdate)}function setMainWindow(i){mainWindow=i}function handleNotificationsClear(){notifications=[],updateNotifications()}function handleNotificationShow(i,e){lastUsedTheme!==e.theme&&(lastUsedTheme=e.theme,webContentsSend(notificationWindow,"UPDATE_THEME",lastUsedTheme)),notifications.push(e),updateNotifications(),setTimeout(()=>{notifications.find(i=>i.id===e.id)&&handleNotificationClose(null,e.id)},5e3)}function handleNotificationClick(i,e){webContentsSend(mainWindow,"NOTIFICATION_CLICK",e),events.emit(NOTIFICATION_CLICK)}let isClosing=[];function handleNotificationClose(i,e){isClosing.includes(e)||(isClosing.push(e),notificationWindow&&webContentsSend(notificationWindow,"FADE_OUT",e),setTimeout(()=>{notifications=notifications.filter(i=>i.id!==e),isClosing=isClosing.filter(i=>i!==e),updateNotifications()},VARIABLES.outDuration))}function handleThemeUpdate(i,e){updateTheme(e)}function updateNotifications(){if(notifications.length>0){if(clearTimeout(hideTimeout),hideTimeout=null,null==notificationWindow)return void createWindow();{const{width:i,height:e,x:n,y:t}=calculateBoundingBox();notificationWindow.setSize(i,e),notificationWindow.setPosition(n,t),notificationWindow.showInactive()}}else null==hideTimeout&&(hideTimeout=setTimeout(()=>destroyWindow(),1.1*VARIABLES.outDuration));null!=notificationWindow&&webContentsSend(notificationWindow,"UPDATE",notifications.slice(0,maxVisible))}let lastUsedTheme="dark";function updateTheme(i){lastUsedTheme=i,null!=notificationWindow&&webContentsSend(notificationWindow,"UPDATE_THEME",i)}function calculateBoundingBox(){const[i,e]=mainWindow.getPosition(),[n,t]=mainWindow.getSize(),o={x:Math.round(i+n/2),y:Math.round(e+t/2)},a=(_electron.screen.getDisplayNearestPoint(o)||_electron.screen.getPrimaryDisplay()).workArea,s=VARIABLES.width,l=maxVisible*VARIABLES.height,d=a.x+a.width-s;let c;switch(screenPosition){case"top":c=a.y;break;case"bottom":c=a.y+a.height-l}return{x:d,y:c,width:s,height:l}}function createWindow(){if(null!=notificationWindow)return;notificationWindow=new _electron.BrowserWindow({title:title,frame:!1,resizable:!1,show:!1,acceptFirstMouse:!0,alwaysOnTop:!0,skipTaskbar:!0,transparent:!0,webPreferences:{nodeIntegration:!0}});const i=_url.default.format({protocol:"file",slashes:!0,pathname:_path.default.join(__dirname,"notifications","index.html")});notificationWindow.loadURL(i),notificationWindow.webContents.on("did-finish-load",()=>{updateTheme(lastUsedTheme),updateNotifications()})}