const fs=require("fs"),{join:join}=require("path"),{pathToFileURL:pathToFileURL}=require("url"),ipc=require("../discord_native/renderer/ipc");let chrtabs,webviews=new Map;function forwardToCurrentWebview(e){return[e,async(...r)=>{let t=webviews.get(document.querySelector(".chrome-tab[active]"));t&&(await t.ready,t.send(e,...r.slice(1)))}]}window.webviews=webviews,ipc.on(...forwardToCurrentWebview("MAIN_WINDOW_FOCUS")),ipc.on(...forwardToCurrentWebview("MAIN_WINDOW_BLUR")),ipc.on(...forwardToCurrentWebview("SYSTEM_TRAY_OPEN_VOICE_SETTINGS")),ipc.on(...forwardToCurrentWebview("SYSTEM_TRAY_TOGGLE_MUTE")),ipc.on(...forwardToCurrentWebview("SYSTEM_TRAY_TOGGLE_DEAFEN")),ipc.on(...forwardToCurrentWebview("LAUNCH_APPLICATION")),ipc.on(...forwardToCurrentWebview("SPELLCHECK_RESULT")),ipc.on(...forwardToCurrentWebview("WINDOW_DEVTOOLS_OPENED")),ipc.on(...forwardToCurrentWebview("WINDOW_DEVTOOLS_CLOSED")),ipc.on(...forwardToCurrentWebview("UPDATE_ERROR")),ipc.on(...forwardToCurrentWebview("UPDATE_NOT_AVAILABLE")),ipc.on(...forwardToCurrentWebview("UPDATE_MANUALLY")),ipc.on(...forwardToCurrentWebview("UPDATE_AVAILABLE")),ipc.on(...forwardToCurrentWebview("MODULE_INSTALL_PROGRESS")),ipc.on(...forwardToCurrentWebview("UPDATE_DOWNLOADED")),ipc.on(...forwardToCurrentWebview("MODULE_INSTALLED")),ipc.on(...forwardToCurrentWebview("CHECKING_FOR_UPDATES")),ipc.on(...forwardToCurrentWebview("UPDATER_HISTORY_RESPONSE")),ipc.on(...forwardToCurrentWebview("ACCESSIBILITY_SUPPORT_CHANGED")),ipc.on(...forwardToCurrentWebview("HELP_OPEN")),ipc.on(...forwardToCurrentWebview("USER_SETTINGS_OPEN")),ipc.on(...forwardToCurrentWebview("MAIN_WINDOW_PATH")),ipc.on(...forwardToCurrentWebview("NAVIGATE_BACK")),ipc.on(...forwardToCurrentWebview("NAVIGATE_FORWARD")),ipc.on("RELOAD",()=>{let e=webviews.get(document.querySelector(".chrome-tab[active]"));e&&e.reload()}),ipc.on("NEW_TAB",()=>{chrtabs.addTab({title:"Jesuscord",favicon:faviconURL})}),ipc.on("CLOSE_TAB",()=>{let e=document.querySelector("div.chrome-tab[active]");e&&chrtabs.removeTab(e)}),ipc.on("OPEN_DEVTOOLS",()=>{let e=webviews.get(document.querySelector(".chrome-tab[active]"));e&&e.openDevTools()}),window.onload=()=>{const e=require("chrome-tabs");require("chrome-tabs/css/chrome-tabs.css"),require("chrome-tabs/css/chrome-tabs-dark-theme.css"),require("./controls.css");let r=document.querySelector(".chrome-tabs"),t=new e;chrtabs=t,t.init(r),r.addEventListener("activeTabChange",({detail:e})=>{let r=webviews.get(e.tabEl);if(!r)return void t.removeTab(e.tabEl);let i=Array.from(webviews.values()).find(e=>e.classList.contains("active-webview"));i&&i.classList.remove("active-webview"),r.classList.add("active-webview")}),r.addEventListener("tabAdd",({detail:e})=>{t.updateTab(e.tabEl,{title:"Jesuscord Loading...",favicon:faviconURL});let r,i=document.createElement("webview");i.src="https://discord.com/app",i.classList.add("discord-webview"),i.classList.add("webview-active"),i.setAttribute("preload",pathToFileURL(join(__dirname,"../tabPreload.js"))),i.shadowRoot.childNodes.item(1).style.height="100%",i.enableremotemodule=!0,i.nodeintegration=!1,i.spellcheck=!0,i.webpreferences="nativeWindowOpen=yes",i.enableblinkfeatures="EnumerateDevices,AudioOutputDevices",i.addEventListener("ipc-message",(function(...e){ipc.send(e[0].channel.replace("DISCORD_",""),e.slice(1))})),i.addEventListener("page-title-updated",()=>{let e=Array.from(webviews.entries()).find(e=>e[1]===i)[0];e&&t.updateTab(e,{favicon:faviconURL,title:i.getTitle()})}),webviews.set(e.tabEl,i),document.querySelector(".documentFull").appendChild(i),i.ready=new Promise(e=>r=e),i.addEventListener("dom-ready",()=>{r()}),i.addEventListener("will-navigate",e=>{e.preventDefault(),console.log(e,e.url)})}),r.addEventListener("tabRemove",({detail:e})=>{let r=webviews.get(e.tabEl);r&&(r.remove(),webviews.delete(e.tabEl),0===document.querySelector(".chrome-tabs-content").childNodes.length&&window.close())}),window.addEventListener("keydown",e=>{if(e.ctrlKey)if("t"===e.key)t.addTab({title:"Jesuscord",favicon:faviconURL});else if("w"===e.key){let e=document.querySelector("div.chrome-tab[active]");if(!e)return;t.removeTab(e)}}),setImmediate(()=>{t.addTab({title:"Jesuscord Loading...",favicon:faviconURL})})},require.extensions[".css"]=(e,r)=>{let t=fs.readFileSync(r,"binary"),i=document.createElement("style");return i.id=Buffer.from(r,"utf8").toString("base64"),i.innerHTML=t,document.head.appendChild(i),e.exports={id:i.id,remove:()=>i.remove()},e.exports};const faviconURL=pathToFileURL(join(__dirname,"../images/discord.png"));