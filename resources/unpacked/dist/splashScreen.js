"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.hasOwnProperty.call(e,n)&&__createBinding(t,e,n);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.pageReady=exports.focusWindow=exports.updateSplashState=exports.initSplash=exports.launchMainWindow=exports.setSplashState=exports.events=exports.APP_SHOULD_SHOW=exports.APP_SHOULD_LAUNCH=void 0;const electron=__importStar(require("electron")),events_1=require("events"),fs=__importStar(require("fs")),path=__importStar(require("path")),moduleUpdater=__importStar(require("./common/moduleUpdater")),paths=__importStar(require("./common/paths")),ipcMain=__importStar(require("./ipcMain")),LOADING_WINDOW_WIDTH=300,LOADING_WINDOW_HEIGHT="darwin"===process.platform?300:350,UPDATE_CHECK_FINISHED="update-check-finished",LAUNCHING="launching";function webContentsSend(e,t,...n){"SPLASH_UPDATE_STATE"===t&&(lastStatus=n[0].status),null!=e&&null!=e.webContents&&e.webContents.send("DISCORD_"+t,...n)}let splashWindow,modulesListeners,splashState,launchedMainWindow,quoteCachePath,lastStatus;function setSplashState(e){splashState=e,null==splashWindow||splashWindow.isDestroyed()||splashWindow.webContents.isDestroyed()||webContentsSend(splashWindow,"SPLASH_UPDATE_STATE",Object.assign({status:lastStatus},splashState))}function launchMainWindow(){launchMainWindowInternal(),updateSplashState(LAUNCHING)}function initSplash(e=!1){modulesListeners={},splashState={},launchedMainWindow=!1,launchSplashWindow(e),quoteCachePath=path.join(paths.getUserData(),"quotes.json"),ipcMain.default.on("UPDATED_QUOTES",(e,t)=>cacheLatestQuotes(t))}function destroySplash(){if(splashWindow){splashWindow.setSkipTaskbar(!0);setTimeout(()=>{splashWindow.hide(),splashWindow.close(),splashWindow=null},100)}}function addModulesListener(e,t){modulesListeners[e]=t,moduleUpdater.events.addListener(e,t)}function removeModulesListeners(){for(const e of Object.keys(modulesListeners))moduleUpdater.events.removeListener(e,modulesListeners[e])}function updateSplashState(e){null==splashWindow||splashWindow.isDestroyed()||splashWindow.webContents.isDestroyed()||webContentsSend(splashWindow,"SPLASH_UPDATE_STATE",Object.assign({status:e},splashState))}function launchSplashWindow(e=!1){const t={width:300,height:LOADING_WINDOW_HEIGHT,transparent:!1,frame:!1,resizable:!1,center:!0,show:!1,webPreferences:{nodeIntegration:!0,enableRemoteModule:!0},icon:path.join(__dirname,"..","modules","discord_desktop_core","core","app","images","discord.png")};splashWindow=new electron.BrowserWindow(t),splashWindow.webContents.session.protocol.interceptFileProtocol("http",(e,t)=>{t(path.join(__dirname,"..","splash",e.url.replace("http://localhost/","")))}),splashWindow.webContents.on("will-navigate",e=>e.preventDefault()),splashWindow.webContents.on("new-window",(e,t)=>{e.preventDefault(),electron.shell.openExternal(t),setTimeout(electron.app.quit,500)}),"darwin"!==process.platform&&splashWindow.on("closed",()=>{splashWindow=null,launchedMainWindow||electron.app.quit()}),ipcMain.default.on("SPLASH_SCREEN_READY",()=>{const t=chooseCachedQuote();t&&webContentsSend(splashWindow,"SPLASH_SCREEN_QUOTE",t),splashWindow&&!e&&splashWindow.show(),moduleUpdater.installPendingUpdates(),exports.events.emit("SPLASH_SCREEN_READY")}),ipcMain.default.on("LAUNCH_ANYWAY",()=>{launchMainWindowInternal()}),splashWindow.loadURL("http://localhost/index.html")}function launchMainWindowInternal(){removeModulesListeners(),launchedMainWindow||null==splashWindow||(launchedMainWindow=!0,exports.events.emit(exports.APP_SHOULD_LAUNCH))}function scheduleUpdateCheck(){}function focusWindow(){null!=splashWindow&&splashWindow.focus()}function pageReady(){destroySplash(),process.nextTick(()=>exports.events.emit(exports.APP_SHOULD_SHOW))}function cacheLatestQuotes(e){fs.writeFile(quoteCachePath,JSON.stringify(e),e=>{e&&console.warn("Failed updating quote cache with error: ",e)})}function chooseCachedQuote(){return"Launching..."}exports.APP_SHOULD_LAUNCH="APP_SHOULD_LAUNCH",exports.APP_SHOULD_SHOW="APP_SHOULD_SHOW",exports.events=new events_1.EventEmitter,exports.setSplashState=setSplashState,exports.launchMainWindow=launchMainWindow,exports.initSplash=initSplash,exports.updateSplashState=updateSplashState,exports.focusWindow=focusWindow,exports.pageReady=pageReady;